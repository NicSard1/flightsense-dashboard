<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>ARASTELLE FlightTest Dashboard – BLE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#5b667a;
      --brand:#0a7cff; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --card:#ffffff; --border:#e5e7eb; --shadow:0 6px 20px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);}
    header{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--border);}
    .bar{display:flex; flex-wrap:wrap; gap:.75rem; align-items:center; justify-content:space-between; padding:.75rem 1rem; max-width:1100px; margin:0 auto;}
    .brand{font-weight:700; letter-spacing:.2px}
    .controls{display:flex; gap:.5rem; flex-wrap:wrap; align-items:center}

    button{
      appearance:none; border:1px solid var(--border); background:#fafafa;
      padding:.7rem 1rem; border-radius:.8rem; font-weight:600; cursor:pointer;
      transition:.15s ease; min-width:110px;
    }
    button:hover{box-shadow:var(--shadow)}
    button.primary{background:var(--brand); color:#fff; border-color:transparent}
    button:disabled{opacity:.55; cursor:not-allowed; box-shadow:none}

    main{padding:1rem; max-width:1100px; margin:0 auto;}
    .grid{display:grid; gap:1rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:1rem; box-shadow:var(--shadow);}
    .label{font-size:.85rem; color:var(--muted);}
    .value{font-size:2.2rem; font-weight:800; line-height:1.1; margin-top:.35rem;}
    .unit{font-size:1.1rem; color:var(--muted); margin-left:.25rem}
    .spark{width:100%; height:110px; display:block; margin-top:.6rem;}
    .minmax{margin-top:.35rem; font-size:.9rem; color:var(--muted)}
    .minmax .k{font-weight:600; color:#334155; margin-right:.25rem}

    .topRight{display:flex; align-items:center; gap:.6rem;}
    .badgeRow{display:flex; align-items:center; gap:.6rem; flex-wrap:wrap;}

    .quick{display:flex; align-items:center; gap:.4rem;}
    .quick label{color:var(--muted); font-size:.85rem; margin:0;}
    .quick select{
      padding:.45rem .6rem; border:1px solid var(--border); border-radius:.6rem;
      background:#fff; color:var(--fg); min-width:120px;
    }

    .pill{
      display:flex; align-items:center; gap:.35rem;
      padding:.45rem .65rem; border:1px solid var(--border); border-radius:999px;
      background:#fff; color:var(--muted); font-size:.9rem; white-space:nowrap;
    }
    .pill .dot{width:10px; height:10px; border-radius:50%; background:var(--danger); display:inline-block;}
    .pill .sep{opacity:.5; margin:0 .25rem;}
    .pill .k{color:#334155; font-weight:600;}
    .unitSmall{font-size:.85rem; color:var(--muted); margin-left:.15rem;}

    .advMenu{position:relative;}
    .iconBtn{min-width:auto; padding:.55rem .75rem; border-radius:.8rem; font-weight:700;}
    .advPanel{
      position:absolute; right:0; top:calc(100% + .5rem);
      width:min(520px, calc(100vw - 2rem));
      background:var(--card); border:1px solid var(--border); border-radius:14px;
      box-shadow:var(--shadow); padding:.75rem; z-index:999;
    }
    .advTitle{font-weight:800; margin:.25rem .25rem .75rem;}
    .opts{display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin:0;}
    .opts label{font-size:.85rem; color:var(--muted); margin-right:.25rem}
    input[type=text], select{
      flex:1 1 240px; min-width:200px;
      padding:.6rem .75rem; border:1px solid var(--border);
      border-radius:.6rem; background:#fff; color:var(--fg);
    }
    .advHint{flex-basis:100%; margin-top:.25rem; font-size:.85rem; color:var(--muted); padding:.25rem;}

    @media (max-width:480px){
      .value{font-size:2rem}
      .controls{width:100%}
      .controls button{flex:1}
      .opts label{flex-basis:100%}
      input[type=text], select{flex-basis:100%}
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">ARASTELLE FlightTest – Dashboard</div>

      <div class="controls">
        <button id="btnConnect" class="primary">Connect BLE</button>
        <button id="btnDisconnect" disabled>Disconnect</button>
        <button id="btnResetMM" title="Réinitialiser min/max">Reset min/max</button>
        <button id="btnLog" title="Start/Stop enregistrement">Start logging</button>
        <button id="btnDownload" disabled>Télécharger CSV</button>
        <button id="btnOpenCsv" disabled>Ouvrir CSV</button>
        <button id="btnCopyCsv" disabled>Copier CSV</button>
      </div>

      <div class="topRight">
        <div class="badgeRow">
          <div class="quick">
            <label for="droneTypeQuick">Drone</label>
            <select id="droneTypeQuick" title="Type de drone testé">
              <option value="USA">USA</option>
              <option value="UKR">UKR</option>
              <option value="TEAL">TEAL</option>
              <option value="Autre">Autre</option>
            </select>
          </div>

          <div class="pill" title="Statut BLE + RSSI (via advertising, si supporté)">
            <span class="dot" id="bleDot"></span>
            <span id="status">Prêt.</span>
            <span class="sep">|</span>
            <span class="k">RSSI</span>
            <span id="valRSSI">—</span><span class="unitSmall">dBm</span>
          </div>
        </div>

        <div class="advMenu">
          <button id="btnAdv" class="iconBtn" aria-haspopup="true" aria-expanded="false" title="Paramètres avancés">⚙️</button>
          <div id="advPanel" class="advPanel" hidden>
            <div class="advTitle">Paramètres avancés</div>
            <div class="opts">
              <label for="devName">Nom exact</label>
              <input id="devName" type="text" value="" title="Nom BLE exact (optionnel)">

              <label for="devPrefix">Préfixe</label>
              <input id="devPrefix" type="text" value="" title="Préfixe du nom (namePrefix)">

              <label for="svc">Service UUID</label>
              <input id="svc" type="text" value="4fafc201-1fb5-459e-8fcc-c5c9c331914b">

              <label for="chr">Characteristic UUID</label>
              <input id="chr" type="text" value="beb5483e-36e1-4688-b7f5-ea07361b26a8">

              <label for="selRate">Cadence log</label>
              <select id="selRate">
                <option value="100">100 ms</option>
                <option value="200" selected>200 ms</option>
                <option value="500">500 ms</option>
                <option value="2000">2000 ms</option>
              </select>

              <div class="advHint">
                Astuce : laisse “Nom exact” vide et utilise seulement le “Préfixe” pour éviter les erreurs.
              </div>
            </div>
          </div>
        </div>
      </div><!-- /topRight -->
    </div><!-- /bar -->
  </header>

  <main>
    <div class="grid">
      <div class="card">
        <div class="label">Courant</div>
        <div class="value"><span id="valI">—</span><span class="unit">A</span></div>
        <div class="minmax"><span class="k">Min</span><span id="minI">—</span>&nbsp;&nbsp;<span class="k">Max</span><span id="maxI">—</span></div>
        <canvas id="plotI" class="spark"></canvas>
      </div>

      <div class="card">
        <div class="label">Tension (V1)</div>
        <div class="value"><span id="valV1">—</span><span class="unit">V</span></div>
        <div class="minmax"><span class="k">Min</span><span id="minV1">—</span>&nbsp;&nbsp;<span class="k">Max</span><span id="maxV1">—</span></div>
        <canvas id="plotV1" class="spark"></canvas>
      </div>

      <div class="card">
        <div class="label">Puissance (instantanée)</div>
        <div class="value"><span id="valP">—</span><span class="unit">W</span></div>
        <div class="minmax"><span class="k">Min</span><span id="minP">—</span>&nbsp;&nbsp;<span class="k">Max</span><span id="maxP">—</span></div>
        <canvas id="plotP" class="spark"></canvas>
      </div>

      <div class="card">
        <div class="label">Température T1</div>
        <div class="value"><span id="valT1">—</span><span class="unit">°C</span></div>
        <div class="minmax"><span class="k">Min</span><span id="minT1">—</span>&nbsp;&nbsp;<span class="k">Max</span><span id="maxT1">—</span></div>
        <canvas id="plotT1" class="spark"></canvas>
      </div>

      <div class="card">
        <div class="label">Température T2</div>
        <div class="value"><span id="valT2">—</span><span class="unit">°C</span></div>
        <div class="minmax"><span class="k">Min</span><span id="minT2">—</span>&nbsp;&nbsp;<span class="k">Max</span><span id="maxT2">—</span></div>
        <canvas id="plotT2" class="spark"></canvas>
      </div>
    </div>
  </main>

<script>
const statusEl = document.getElementById('status');
const btnConnect = document.getElementById('btnConnect');
const btnDisconnect = document.getElementById('btnDisconnect');
const btnResetMM = document.getElementById('btnResetMM');
const btnLog = document.getElementById('btnLog');
const btnDownload = document.getElementById('btnDownload');
const btnOpenCsv = document.getElementById('btnOpenCsv');
const btnCopyCsv = document.getElementById('btnCopyCsv');

const btnAdv   = document.getElementById('btnAdv');
const advPanel = document.getElementById('advPanel');

const devNameInput   = document.getElementById('devName');
const devPrefixInput = document.getElementById('devPrefix');
const svcInput = document.getElementById('svc');
const chrInput = document.getElementById('chr');
const selRate  = document.getElementById('selRate');

const droneSel = document.getElementById('droneTypeQuick');

const bleDot  = document.getElementById('bleDot');
const valRSSI = document.getElementById('valRSSI');

const vI  = document.getElementById('valI');
const vV1 = document.getElementById('valV1');
const vP  = document.getElementById('valP');
const vT1 = document.getElementById('valT1');
const vT2 = document.getElementById('valT2');

const minI = document.getElementById('minI');
const maxI = document.getElementById('maxI');
const minV1 = document.getElementById('minV1');
const maxV1 = document.getElementById('maxV1');
const minP = document.getElementById('minP');
const maxP = document.getElementById('maxP');
const minT1 = document.getElementById('minT1');
const maxT1 = document.getElementById('maxT1');
const minT2 = document.getElementById('minT2');
const maxT2 = document.getElementById('maxT2');

const canvI  = document.getElementById('plotI');
const canvV1 = document.getElementById('plotV1');
const canvP  = document.getElementById('plotP');
const canvT1 = document.getElementById('plotT1');
const canvT2 = document.getElementById('plotT2');

let ctxI, ctxV1, ctxP, ctxT1, ctxT2;
let device=null, server=null, characteristic=null;

/* ---------- Helpers ---------- */
function setStatus(t){ statusEl.textContent = t; }
function fmt(v,d=2){ return Number.isFinite(v) ? v.toFixed(d) : '—'; }
function setBleDot(colorCss){ if (bleDot) bleDot.style.background = colorCss; }

function formatDateHeader(d = new Date()){
  const pad = n => String(n).padStart(2,'0');
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* ---------- Advanced menu ---------- */
function openAdv(){ advPanel.hidden = false; btnAdv.setAttribute('aria-expanded', 'true'); }
function closeAdv(){ advPanel.hidden = true; btnAdv.setAttribute('aria-expanded', 'false'); }
btnAdv.addEventListener('click', (e)=>{ e.stopPropagation(); advPanel.hidden ? openAdv() : closeAdv(); });
document.addEventListener('click', ()=>{ if (!advPanel.hidden) closeAdv(); });
advPanel.addEventListener('click', (e)=> e.stopPropagation());
document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !advPanel.hidden) closeAdv(); });

/* ---------- Min/Max ---------- */
const mm = {
  I:  {min:+Infinity, max:-Infinity, d:3},
  V1: {min:+Infinity, max:-Infinity, d:3},
  P:  {min:+Infinity, max:-Infinity, d:1},
  T1: {min:+Infinity, max:-Infinity, d:1},
  T2: {min:+Infinity, max:-Infinity, d:1},
};
function updateMM(key, val){
  if (!Number.isFinite(val)) return;
  const s = mm[key];
  if (val < s.min) s.min = val;
  if (val > s.max) s.max = val;

  if (key==='I')  { minI.textContent  = fmt(s.min,s.d); maxI.textContent  = fmt(s.max,s.d); }
  if (key==='V1') { minV1.textContent = fmt(s.min,s.d); maxV1.textContent = fmt(s.max,s.d); }
  if (key==='P')  { minP.textContent  = fmt(s.min,s.d); maxP.textContent  = fmt(s.max,s.d); }
  if (key==='T1') { minT1.textContent = fmt(s.min,s.d); maxT1.textContent = fmt(s.max,s.d); }
  if (key==='T2') { minT2.textContent = fmt(s.min,s.d); maxT2.textContent = fmt(s.max,s.d); }
}
function resetMM(){
  for (const k of Object.keys(mm)) { mm[k].min=+Infinity; mm[k].max=-Infinity; }
  minI.textContent = maxI.textContent = '—';
  minV1.textContent = maxV1.textContent = '—';
  minP.textContent = maxP.textContent = '—';
  minT1.textContent = maxT1.textContent = '—';
  minT2.textContent = maxT2.textContent = '—';
}

/* ---------- Canvas sizing ---------- */
function fitCanvas(canvas, targetH=110){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const cssW = canvas.clientWidth;
  const cssH = targetH;
  canvas.width  = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return ctx;
}
function resizeAll(){
  ctxI  = fitCanvas(canvI);
  ctxV1 = fitCanvas(canvV1);
  ctxP  = fitCanvas(canvP);
  ctxT1 = fitCanvas(canvT1);
  ctxT2 = fitCanvas(canvT2);
  drawSparkline(ctxI,  bufs.I);
  drawSparkline(ctxV1, bufs.V1);
  drawSparkline(ctxP,  bufs.P);
  drawSparkline(ctxT1, bufs.T1);
  drawSparkline(ctxT2, bufs.T2);
}
window.addEventListener('resize', () => { clearTimeout(resizeAll._t); resizeAll._t=setTimeout(resizeAll, 120); });

/* ---------- Sparklines ---------- */
const BUFLEN = 180; // ajuste si besoin
const bufs = { I:[], V1:[], P:[], T1:[], T2:[] };
function push(buf, val){ buf.push(val); if(buf.length>BUFLEN) buf.shift(); }
function drawSparkline(ctx, data){
  const W = ctx.canvas.clientWidth, H = ctx.canvas.clientHeight;
  ctx.clearRect(0,0,W,H);
  if (data.length < 2) return;

  let min=Infinity, max=-Infinity;
  for(const v of data){
    if(Number.isFinite(v)){
      if(v<min)min=v;
      if(v>max)max=v;
    }
  }
  if (!Number.isFinite(min) || !Number.isFinite(max) || min===max){ min -= 1; max += 1; }
  const pad = 6;
  ctx.lineWidth = 2;
  ctx.strokeStyle = '#0a7cff';
  ctx.beginPath();
  data.forEach((v,i)=>{
    const x = pad + (W-2*pad) * (i/(data.length-1));
    const y = H-pad - ((v-min)/(max-min))*(H-2*pad);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

/* ---------- CSV logging ---------- */
let isLogging = false;
let logRows = [];
let logTimer = null;
let lastSample = {I:NaN, V1:NaN, P:NaN, T1:NaN, T2:NaN, has:false};

function toFixedComma(n, d){ return Number.isFinite(n) ? n.toFixed(d).replace('.', ',') : ''; }
function nowIsoLocal(){
  const d = new Date();
  const tz = -d.getTimezoneOffset();
  const sign = tz >= 0 ? '+' : '-';
  const hh = String(Math.floor(Math.abs(tz)/60)).padStart(2,'0');
  const mm = String(Math.abs(tz)%60).padStart(2,'0');
  return d.toISOString().replace('Z','') + sign + hh + ':' + mm;
}
function refreshExportButtons(){
  const hasData = logRows.length > 1;
  btnDownload.disabled = !hasData;
  btnOpenCsv.disabled  = !hasData;
  btnCopyCsv.disabled  = !hasData;
}
function startLogging(){
  droneSel.disabled = true;
  logRows = [];
  logRows.push("# FlightTest FSM");
  logRows.push("# Date: " + formatDateHeader());
  logRows.push("# Drone: " + droneSel.value);
  logRows.push("# DeviceName: " + (device?.name || "N/A"));
  logRows.push("");
  logRows.push("timestamp;I_A;V_V;P_W;T1_C;T2_C");

  isLogging = true;
  btnLog.textContent = 'Stop logging';
  setStatus('Enregistrement en cours…');
  refreshExportButtons();

  const period = parseInt(selRate.value,10) || 1000;
  if (logTimer) clearInterval(logTimer);
  logTimer = setInterval(() => {
    if (!isLogging || !lastSample.has) return;
    logRows.push([
      nowIsoLocal(),
      toFixedComma(lastSample.I,  3),
      toFixedComma(lastSample.V1, 3),
      toFixedComma(lastSample.P,  1),
      toFixedComma(lastSample.T1, 1),
      toFixedComma(lastSample.T2, 1)
    ].join(';'));
    refreshExportButtons();
  }, period);
}
function stopLogging(){
  isLogging = false;
  droneSel.disabled = false;
  btnLog.textContent = 'Start logging';
  setStatus('Enregistrement stoppé.');
  if (logTimer) { clearInterval(logTimer); logTimer = null; }
  refreshExportButtons();
}
function downloadCSV(){
  if (logRows.length <= 1) return;
  const csv = logRows.join('\n') + '\n';
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  a.href = url;
  a.download = `FlightTest_${ts}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  setStatus('CSV téléchargé');
}
function openCSVInTab(){
  if (logRows.length <= 1) return;
  const csv = logRows.join('\n') + '\n';
  const win = window.open();
  if (!win) { setStatus('Pop-up bloquée. Autorise les pop-up.'); return; }
  win.document.write('<pre style="white-space:pre-wrap;word-wrap:break-word;margin:1rem;">'
    + csv.replace(/&/g,'&amp;').replace(/</g,'&lt;')
    + '</pre>');
  setStatus('CSV ouvert. Sélectionne et copie.');
}
async function copyCSV(){
  if (logRows.length <= 1) return;
  const csv = logRows.join('\n') + '\n';
  try{
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(csv);
      setStatus('CSV copié dans le presse-papiers.');
    } else {
      const ta = document.createElement('textarea');
      ta.value = csv;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      setStatus('CSV copié.');
    }
  }catch(e){
    setStatus('Impossible de copier. Utilise “Ouvrir CSV”.');
  }
}

/* ---------- RSSI via watchAdvertisements() ---------- */
let advHandler = null;

function updateRssi(rssi){
  valRSSI.textContent = Number.isFinite(rssi) ? String(Math.round(rssi)) : '—';
  if (!Number.isFinite(rssi)) setBleDot('var(--danger)');
  else if (rssi > -65) setBleDot('var(--ok)');
  else if (rssi > -80) setBleDot('var(--warn)');
  else setBleDot('var(--danger)');
}

async function startRssiWatch(){
  updateRssi(NaN);
  if (!device) return;

  if (!device.watchAdvertisements) {
    console.warn("watchAdvertisements() not supported in this browser.");
    return;
  }

  stopRssiWatch();

  advHandler = (event) => updateRssi(event.rssi);
  device.addEventListener('advertisementreceived', advHandler);

  try{
    await device.watchAdvertisements();
  }catch(e){
    console.warn("watchAdvertisements failed:", e);
  }
}
function stopRssiWatch(){
  if (device && advHandler) device.removeEventListener('advertisementreceived', advHandler);
  advHandler = null;
  updateRssi(NaN);
}

/* ---------- BLE parsing ---------- */
function parseMaybeNaN(tok){
  const t = String(tok ?? '').trim();
  if (!t) return NaN;
  if (t.toLowerCase() === 'nan') return NaN;
  const v = parseFloat(t);
  return Number.isFinite(v) ? v : NaN;
}

function handleNotif(event){
  const dv = event.target.value;
  let s = '';
  for(let i=0;i<dv.byteLength;i++) s += String.fromCharCode(dv.getUint8(i));
  const tok = s.split(';');

  // Attendu: I;V;P;T1;T2
  const I  = parseMaybeNaN(tok[0]);
  const V1 = parseMaybeNaN(tok[1]);
  const P  = parseMaybeNaN(tok[2]);
  const T1 = parseMaybeNaN(tok[3]);
  const T2 = parseMaybeNaN(tok[4]);

  vI.textContent  = fmt(I,3);
  vV1.textContent = fmt(V1,3);
  vP.textContent  = Number.isFinite(P)  ? fmt(P,1)  : '—';
  vT1.textContent = Number.isFinite(T1) ? fmt(T1,1) : '—';
  vT2.textContent = Number.isFinite(T2) ? fmt(T2,1) : '—';

  updateMM('I', I);
  updateMM('V1', V1);
  if (Number.isFinite(P))  updateMM('P', P);
  if (Number.isFinite(T1)) updateMM('T1', T1);
  if (Number.isFinite(T2)) updateMM('T2', T2);

  push(bufs.I, I);   drawSparkline(ctxI,  bufs.I);
  push(bufs.V1, V1); drawSparkline(ctxV1, bufs.V1);
  if (Number.isFinite(P)) push(bufs.P, P);
  drawSparkline(ctxP, bufs.P);

  if (Number.isFinite(T1)) push(bufs.T1, T1);
  if (Number.isFinite(T2)) push(bufs.T2, T2);
  drawSparkline(ctxT1, bufs.T1);
  drawSparkline(ctxT2, bufs.T2);

  lastSample = {I, V1, P, T1, T2, has:true};
}

/* ---------- BLE connect/disconnect ---------- */
async function connect(){
  try{
    if (!('bluetooth' in navigator)) {
      setStatus('Web Bluetooth non supporté. Utilise Chrome/Edge desktop.');
      return;
    }

    btnConnect.disabled = true;
    setStatus('Scan BLE…');

    const serviceUuid = svcInput.value.trim();
    const charUuid    = chrInput.value.trim();
    const exactName   = devNameInput.value.trim();
    const prefix      = devPrefixInput.value.trim();

    const filters = [];
    if (exactName.length > 0) filters.push({ name: exactName });
    else if (prefix.length > 0) filters.push({ namePrefix: prefix });
    else filters.push({ namePrefix: "FSM" });

    device = await navigator.bluetooth.requestDevice({
      filters,
      optionalServices: [serviceUuid]
    });

    await startRssiWatch();

    device.addEventListener('gattserverdisconnected', onDisconnected);

    setStatus('Connexion GATT…');
    server = await device.gatt.connect();

    setStatus('Service…');
    const service = await server.getPrimaryService(serviceUuid);

    setStatus('Characteristic…');
    characteristic = await service.getCharacteristic(charUuid);

    setStatus('Notifications…');
    await characteristic.startNotifications();
    characteristic.addEventListener('characteristicvaluechanged', handleNotif);

    setBleDot('var(--ok)');
    setStatus(`Connecté à "${device.name}"`);
    btnDisconnect.disabled = false;

  }catch(e){
    console.error(e);
    setStatus('Erreur: ' + e.message);
    btnConnect.disabled = false;
    setBleDot('var(--danger)');
    stopRssiWatch();
  }
}

async function disconnect(){
  try{
    if (characteristic){
      await characteristic.stopNotifications().catch(()=>{});
      characteristic.removeEventListener('characteristicvaluechanged', handleNotif);
      characteristic = null;
    }
    if (device && device.gatt?.connected) device.gatt.disconnect();
  }finally{
    onDisconnected();
  }
}

function onDisconnected(){
  stopRssiWatch();
  setBleDot('var(--danger)');
  setStatus('Déconnecté.');
  btnConnect.disabled = false;
  btnDisconnect.disabled = true;
  lastSample = {I:NaN, V1:NaN, P:NaN, T1:NaN, T2:NaN, has:false};
}

/* ---------- Init ---------- */
btnConnect.addEventListener('click', connect);
btnDisconnect.addEventListener('click', disconnect);
btnResetMM.addEventListener('click', resetMM);
btnLog.addEventListener('click', () => isLogging ? stopLogging() : startLogging());
btnDownload.addEventListener('click', downloadCSV);
btnOpenCsv.addEventListener('click', openCSVInTab);
btnCopyCsv.addEventListener('click', copyCSV);

if (!('bluetooth' in navigator)){
  setStatus('Web Bluetooth non supporté dans ce navigateur. Utilise Chrome/Edge desktop.');
}
resizeAll();
</script>
</body>
</html>
