<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>FlightTest Dashboard – BLE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Arial, sans-serif; background:#0e1117; color:#e6edf3; margin:0; }
    header { background:#0077cc; padding:14px 16px; font-weight:700; }
    main { padding:18px; max-width:1100px; margin:0 auto; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    button { padding:10px 14px; border:0; border-radius:10px; background:#238636; color:#fff; font-weight:600; cursor:pointer; }
    button:disabled { background:#3a3a3a; cursor:not-allowed; }
    input[type=text]{ padding:8px 10px; border-radius:8px; border:1px solid #30363d; background:#0f141b; color:#e6edf3; width:420px; }
    small { color:#9da7b3; }
    #status { margin-left:8px; }
    .grid { display:grid; grid-template-columns: repeat(3, minmax(240px, 1fr)); gap:16px; margin-top:16px; }
    .card { background:#161b22; border:1px solid #30363d; border-radius:12px; padding:16px; }
    .label { font-size:12px; color:#9da7b3; }
    .value { font-size:36px; font-weight:700; margin-top:6px; }
    canvas { width:100%; height:90px; display:block; margin-top:10px; }
    .hint { margin-top:10px; color:#9da7b3; }
  </style>
</head>
<body>
  <header>FlightTest Dashboard – BLE</header>
  <main>
    <div class="row" style="margin-bottom:10px">
      <button id="btnConnect">Connect BLE</button>
      <button id="btnDisconnect" disabled>Disconnect</button>
      <span id="status"><small>Prêt.</small></span>
    </div>

    <div class="row" style="margin-bottom:10px">
      <small>Service UUID:</small>
      <input id="svc" type="text" value="4fafc201-1fb5-459e-8fcc-c5c9c331914b">
      <small style="margin-left:10px">Characteristic UUID:</small>
      <input id="chr" type="text" value="beb5483e-36e1-4688-b7f5-ea07361b26a8">
    </div>

    <div class="grid">
      <div class="card">
        <div class="label">Courant (A)</div>
        <div class="value" id="valI">—</div>
        <canvas id="plotI" width="400" height="90"></canvas>
      </div>
      <div class="card">
        <div class="label">Tension (V1)</div>
        <div class="value" id="valV1">—</div>
        <canvas id="plotV1" width="400" height="90"></canvas>
      </div>
      <div class="card">
        <div class="label">Température (°C)</div>
        <div class="value" id="valT">—</div>
        <canvas id="plotT" width="400" height="90"></canvas>
      </div>
    </div>
    
  </main>

<script>
const statusEl = document.getElementById('status');
const btnConnect = document.getElementById('btnConnect');
const btnDisconnect = document.getElementById('btnDisconnect');
const svcInput = document.getElementById('svc');
const chrInput = document.getElementById('chr');

const vI  = document.getElementById('valI');
const vV1 = document.getElementById('valV1');
const vT  = document.getElementById('valT');

const BUFLEN = 200;
const bufs = { I:[], V1:[], T:[] };
const ctxI  = document.getElementById('plotI').getContext('2d');
const ctxV1 = document.getElementById('plotV1').getContext('2d');
const ctxT  = document.getElementById('plotT').getContext('2d');

let device=null, server=null, characteristic=null;

function setStatus(t){ statusEl.innerHTML = `<small>${t}</small>`; }
function fmt(v, d=2){ return Number.isFinite(v) ? v.toFixed(d) : '—'; }

function push(buf, val){
  buf.push(val);
  if (buf.length > BUFLEN) buf.shift();
}
function drawSparkline(ctx, data){
  const W=ctx.canvas.width, H=ctx.canvas.height;
  ctx.clearRect(0,0,W,H);
  if (data.length<2) return;
  let min=Infinity, max=-Infinity;
  for (const x of data) if (Number.isFinite(x)){ if (x<min) min=x; if (x>max) max=x; }
  if (!Number.isFinite(min)||!Number.isFinite(max)||min===max){ min -= 1; max += 1; }
  const pad=6; ctx.strokeStyle='#58a6ff'; ctx.lineWidth=2; ctx.beginPath();
  data.forEach((v,i)=>{
    const x = pad + (W-2*pad) * (i/(data.length-1));
    const y = H-pad - ((v-min)/(max-min))*(H-2*pad);
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

function handleNotif(event){
  const dv = event.target.value;
  let s = '';
  for (let i=0;i<dv.byteLength;i++) s += String.fromCharCode(dv.getUint8(i));
  s = s.trim();
  const line = s.split(/\r?\n/).pop();

  const tok = line.split(';');
  if (tok.length < 3) return;

  const I  = parseFloat(tok[0]);    // courant
  const V1 = parseFloat(tok[1]);    // tension
  const T  = (tok[2].toUpperCase?.()==='NAN') ? NaN : parseFloat(tok[2]);

  vI.textContent  = Number.isFinite(I)  ? I.toFixed(3) : '—';
  vV1.textContent = Number.isFinite(V1) ? V1.toFixed(3) : '—';
  vT.textContent  = Number.isFinite(T)  ? T.toFixed(2)  : '—';

  push(bufs.I, I);   drawSparkline(ctxI, bufs.I);
  push(bufs.V1, V1); drawSparkline(ctxV1, bufs.V1);
  if (Number.isFinite(T)) push(bufs.T, T);
  drawSparkline(ctxT, bufs.T);
}

async function connect(){
  try{
    btnConnect.disabled = true;
    setStatus('Scan BLE…');

    const serviceUuid = svcInput.value.trim();
    const charUuid    = chrInput.value.trim();

    device = await navigator.bluetooth.requestDevice({
      filters:[{ services:[serviceUuid] }],
      optionalServices:[serviceUuid]
    });
    device.addEventListener('gattserverdisconnected', onDisconnected);

    setStatus('Connexion GATT…');
    server = await device.gatt.connect();

    setStatus('Récupération service…');
    const service = await server.getPrimaryService(serviceUuid);

    setStatus('Récupération caractéristique…');
    characteristic = await service.getCharacteristic(charUuid);

    setStatus('Abonnement notifications…');
    await characteristic.startNotifications();
    characteristic.addEventListener('characteristicvaluechanged', handleNotif);

    setStatus('Connecté & abonné ✅');
    btnDisconnect.disabled = false;

  }catch(e){
    console.error(e);
    setStatus('Erreur: '+ e.message);
    btnConnect.disabled = false;
  }
}

async function disconnect(){
  try{
    if (characteristic){
      await characteristic.stopNotifications().catch(()=>{});
      characteristic.removeEventListener('characteristicvaluechanged', handleNotif);
      characteristic = null;
    }
    if (device && device.gatt.connected) device.gatt.disconnect();
  }finally{
    onDisconnected();
  }
}
function onDisconnected(){
  setStatus('Déconnecté.');
  btnConnect.disabled = false;
  btnDisconnect.disabled = true;
}

btnConnect.addEventListener('click', connect);
btnDisconnect.addEventListener('click', disconnect);

// Petit test de support
if (!('bluetooth' in navigator)){
  setStatus('Web Bluetooth non supporté dans ce navigateur.');
}
</script>
</body>
</html>
